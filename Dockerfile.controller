FROM node:22-alpine AS web-build
WORKDIR /web
COPY web/package*.json ./
RUN --mount=type=cache,target=/root/.npm npm ci
COPY web/ .
RUN npm run build

FROM golang:1.25-alpine AS go-build
WORKDIR /app
COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod go mod download
COPY . .
RUN --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -trimpath -o controller ./cmd/controller \
    && CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -trimpath -o agent-amd64 ./cmd/agent \
    && CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -trimpath -o agent-arm64 ./cmd/agent

FROM debian:stable-slim
RUN apt-get update && apt-get install -y \
    ca-certificates \
    mtools \
    wget \
    xz-utils \
    qemu-user-static \
    fdisk \
    mount \
    parted \
    udev \
    e2fsprogs \
    dosfstools \
    && rm -rf /var/lib/apt/lists/*
COPY --from=go-build /app/controller /app/controller
COPY --from=go-build /app/agent-amd64 /app/agent-amd64
COPY --from=go-build /app/agent-arm64 /app/agent-arm64
COPY --from=web-build /web/dist /app/web/dist
ENV WEB_ROOT=/app/web/dist
ENV AGENT_BINARY_DIR=/app
ENV AGENT_BINARY_PATH=/app/agent
EXPOSE 8080
CMD ["/app/controller"]
