services:
  mqtt:
    image: eclipse-mosquitto:2
    container_name: turtlebot-mqtt
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf

  traefik:
    image: traefik:v2.11
    container_name: turtlebot-traefik
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=admin@nbembedded.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certificates:/letsencrypt

  controller:
    build:
      context: .
      dockerfile: Dockerfile.controller
    image: nbembedded/turtlebot-controller:0.0.1
    container_name: turtlebot-controller
    privileged: true
    depends_on:
      - mqtt
    environment:
      - MQTT_BROKER=tcp://mqtt:1883
      - AGENT_MQTT_BROKER=tcp://demo.nbembedded.com:1883
      - DB_PATH=/data/controller.db
      - DEMO_MODE=false
      - ADMIN_PASSWORD=turtle2025
      # Optional: Manually specify subnets to scan if Docker hides host interfaces
      - SCAN_SUBNETS=192.168.1.0/24
    volumes:
      - controller-data:/data
    labels:
      - "traefik.enable=true"
      
      # Router for Production (Let's Encrypt)
      - "traefik.http.routers.controller.rule=Host(`demo.nbembedded.com`)"
      - "traefik.http.routers.controller.entrypoints=websecure"
      - "traefik.http.routers.controller.tls.certresolver=myresolver"
      - "traefik.http.routers.controller.middlewares=rate-limit,secure-headers"
      
      # Router for Localhost (Self-Signed fallback)
      - "traefik.http.routers.controller-local.rule=Host(`localhost`)"
      - "traefik.http.routers.controller-local.entrypoints=websecure"
      - "traefik.http.routers.controller-local.tls=true"
      - "traefik.http.routers.controller-local.middlewares=rate-limit,secure-headers"

      # Service Definition
      - "traefik.http.services.controller.loadbalancer.server.port=8080"
      
      # Security Middlewares
      - "traefik.http.middlewares.rate-limit.ratelimit.average=100"
      - "traefik.http.middlewares.rate-limit.ratelimit.burst=50"
      - "traefik.http.middlewares.secure-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.secure-headers.headers.stsseconds=31536000"
      - "traefik.http.middlewares.secure-headers.headers.browserxssfilter=true"
      - "traefik.http.middlewares.secure-headers.headers.contenttypenosniff=true"
      - "traefik.http.middlewares.secure-headers.headers.framedeny=true"

  robot1:
    build:
      context: .
      dockerfile: Dockerfile.robot
    image: nbembedded/turtlebot-robot:0.0.1
    container_name: turtlebot-robot1
    environment:
      - AGENT_ID=robot1
      - MQTT_BROKER=tcp://mqtt:1883
    depends_on:
      - mqtt

  robot2:
    build:
      context: .
      dockerfile: Dockerfile.robot
    image: nbembedded/turtlebot-robot:0.0.1
    container_name: turtlebot-robot2
    environment:
      - AGENT_ID=robot2
      - MQTT_BROKER=tcp://mqtt:1883
    depends_on:
      - mqtt

  robot3:
    build:
      context: .
      dockerfile: Dockerfile.robot
    image: nbembedded/turtlebot-robot:0.0.1
    container_name: turtlebot-robot3
    environment:
      - AGENT_ID=robot3
      - MQTT_BROKER=tcp://mqtt:1883
    depends_on:
      - mqtt

  laptop1:
    build:
      context: .
      dockerfile: Dockerfile.laptop
    image: nbembedded/turtlebot-laptop:0.0.1
    container_name: turtlebot-laptop1
    environment:
      - AGENT_ID=laptop1
      - MQTT_BROKER=tcp://mqtt:1883
    depends_on:
      - mqtt

  laptop2:
    build:
      context: .
      dockerfile: Dockerfile.laptop
    container_name: turtlebot-laptop2
    image: nbembedded/turtlebot-laptop:0.0.1
    environment:
      - AGENT_ID=laptop2
      - MQTT_BROKER=tcp://mqtt:1883
    depends_on:
      - mqtt

  laptop3:
    build:
      context: .
      dockerfile: Dockerfile.laptop
    image: nbembedded/turtlebot-laptop:0.0.1
    container_name: turtlebot-laptop3
    environment:
      - AGENT_ID=laptop3
      - MQTT_BROKER=tcp://mqtt:1883
    depends_on:
      - mqtt

volumes:
  controller-data:
  traefik-certificates:
