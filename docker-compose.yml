services:
  mqtt:
    image: eclipse-mosquitto:2
    container_name: turtlebot-mqtt
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf

  traefik:
    image: traefik:v2.11
    container_name: turtlebot-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=admin@nbembedded.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certificates:/letsencrypt

  controller:
    build:
      context: .
      dockerfile: Dockerfile.controller
    container_name: turtlebot-controller
    privileged: true
    depends_on:
      - mqtt
    environment:
      - MQTT_BROKER=tcp://mqtt:1883
      - AGENT_MQTT_BROKER=tcp://192.168.100.122:1883
      - DB_PATH=/data/controller.db
      - DEMO_MODE=true
      # Optional: Manually specify subnets to scan if Docker hides host interfaces
      - SCAN_SUBNETS=192.168.1.0/24,192.168.100.0/24
    volumes:
      - controller-data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.controller.rule=Host(`demo2.nbembedded.com`)"
      - "traefik.http.routers.controller.entrypoints=websecure"
      - "traefik.http.routers.controller.tls.certresolver=myresolver"
      - "traefik.http.services.controller.loadbalancer.server.port=8080"

volumes:
  controller-data:
  traefik-certificates:
